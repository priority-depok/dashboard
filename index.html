<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA & Mobile App Meta Tags -->
    <title>Dashboard Siswa Priority Depok</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">

    <!-- iOS "Add to Home Screen" support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dashboard">
    <link rel="apple-touch-icon" href="apple-icon-180x180.png">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f0f0;
        }
        .responsive-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            visibility: hidden;
        }
        .loader {
            border: 8px solid #dddddd;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* --- Install Prompt Card Styles --- */
        #install-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Awalnya tersembunyi */
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom); /* Untuk notch iPhone */
        }
        #install-card {
            background-color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        #install-card h3 {
            margin: 0 0 10px 0;
        }
        #install-card p {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #333;
        }
        #install-controls {
            display: flex;
            gap: 10px;
        }
        .install-button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #install-button {
            background-color: #3498db;
            color: white;
        }
        #later-button {
            background-color: #ecf0f1;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    
    <div id="loading-spinner" class="loader"></div>

    <iframe 
        id="webapp-iframe"
        class="responsive-iframe"
        src=""
        allowfullscreen="true"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation"
        referrerpolicy="no-referrer-when-downgrade">
    </iframe>

    <!-- --- Install Prompt Card HTML --- -->
    <div id="install-overlay">
        <div id="install-card">
            <h3>Install Aplikasi</h3>
            <p>Tambahkan dashboard ini ke beranda Anda untuk akses cepat.</p>
            <div id="install-controls">
                <button id="later-button" class="install-button">Nanti Saja</button>
                <button id="install-button" class="install-button">Install</button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt; // Variabel untuk menyimpan event install
        const installOverlay = document.getElementById('install-overlay');
        const installButton = document.getElementById('install-button');
        const laterButton = document.getElementById('later-button');

        // --- 1. Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('ServiceWorker registration failed: ', registrationError);
                    });
            });
        }

        // --- 2. Install Prompt Logic (Hanya untuk Android/Chrome) ---
        window.addEventListener('beforeinstallprompt', (e) => {
            // Mencegah prompt bawaan Chrome
            e.preventDefault();
            // Simpan event untuk nanti
            deferredPrompt = e;
            // Tampilkan card custom kita
            installOverlay.style.display = 'block';
        });

        // Saat tombol "Install" diklik
        installButton.addEventListener('click', async () => {
            // Sembunyikan card
            installOverlay.style.display = 'none';
            // Tampilkan prompt install
            if (deferredPrompt) {
                deferredPrompt.prompt();
                // Tunggu respons pengguna
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Kosongkan variabel
                deferredPrompt = null;
            }
        });

        // Saat tombol "Nanti Saja" diklik
        laterButton.addEventListener('click', () => {
            installOverlay.style.display = 'none';
            deferredPrompt = null;
        });

        // --- 3. Iframe Loader Logic (Kode Anda sebelumnya) ---
        window.addEventListener('load', function() {
            const iframe = document.getElementById('webapp-iframe');
            const loader = document.getElementById('loading-spinner');

            // --- GANTI ID-SCRIPT-ANDA DI BAWAH INI ---
            const appScriptId = 'AKfycbwz0q7gqChfy2-WWK7a_dgsraH-Y1zekx1fx9qaZISZxF0UqNRIqV9eLBmvqw348suk';
            // -----------------------------------------

            const appScriptUrl = `https://script.google.com/macros/s/${appScriptId}/exec?authuser=0`;

            iframe.src = appScriptUrl;

            iframe.onload = function() {
                loader.style.display = 'none';
                iframe.style.visibility = 'visible';
                 // --- PERUBAHAN DIMULAI ---
                // Tambahkan state ke history setelah app dimuat
                // Ini menciptakan "jebakan" agar tombol kembali tidak menutup app
                if (window.location.hash !== '#app') {
                    history.pushState({ page: "app" }, "App", "#app");
                }
                // --- PERUBAHAN SELESAI ---
            };
            
            iframe.onerror = function() {
                loader.style.display = 'none';
                document.body.innerHTML = '<p style="text-align:center; padding-top: 40vh;">Gagal memuat aplikasi. Silakan coba lagi nanti.</p>';
            };
        });
        
        // --- PERUBAHAN DIMULAI ---
        // Tangani event tombol kembali (popstate)
        window.addEventListener('popstate', function(event) {
            const iframe = document.getElementById('webapp-iframe');
            // Jika iframe sudah terlihat (app berjalan) dan pengguna menekan "kembali"
            // (yang akan menghapus hash #app), kita dorong mereka kembali ke #app.
            if (iframe.style.visibility === 'visible' && window.location.hash !== '#app') {
                history.pushState({ page: "app" }, "App", "#app");
                console.log("Tombol kembali ditekan, mencegah aplikasi keluar.");
            }
        });
        // --- PERUBAHAN SELESAI ---
    </script>

</body>
</html>

